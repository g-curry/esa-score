<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯æ€§èƒ½è·‘åˆ†å·¥å…·ï¼ˆçº¯å‰ç«¯ç¨³å®šç‰ˆï¼‰</title>
    <!-- å¼•å…¥ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft Yahei", Arial, sans-serif; }
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        h1 { color: #333; margin-bottom: 20px; text-align: center; }
        .input-area { margin-bottom: 30px; padding: 25px; border: 1px solid #eee; border-radius: 12px; background: #f9f9f9; }
        .input-item { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 15px; }
        input, select, button { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #0088ff; box-shadow: 0 0 0 2px rgba(0,136,255,0.1); }
        button { 
            background: #0088ff; color: white; border: none; cursor: pointer; 
            font-weight: 600; transition: background 0.3s;
        }
        button:hover { background: #0077ee; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .tips { font-size: 12px; color: #666; margin-top: 5px; line-height: 1.5; }
        .tips.warning { color: #ff6600; background: #fff8f0; padding: 8px; border-radius: 4px; margin-top: 8px; }
        .result-area { display: none; margin-top: 30px; }
        .metrics { margin-bottom: 25px; padding: 20px; border: 1px solid #eee; border-radius: 10px; }
        .metric-item { margin-bottom: 12px; font-size: 14px; color: #333; }
        .metric-item strong { color: #0088ff; }
        .metric-item .limited { color: #ff6600; font-size: 12px; margin-left: 8px; }
        .score-box { display: inline-block; padding: 8px 15px; border-radius: 6px; color: white; font-weight: 600; margin-bottom: 15px; }
        .score-A { background: #00cc66; }
        .score-B { background: #ff9900; }
        .score-C { background: #ff6600; }
        .score-D { background: #ff3300; }
        .chart { width: 100%; height: 450px; margin: 25px 0; }
        .resources-detail { margin: 20px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        .resources-detail h3 { margin-bottom: 10px; font-size: 16px; color: #333; }
        .resource-item { padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 13px; }
        .resource-item:last-child { border-bottom: none; }
        .suggestions { margin-top: 20px; padding: 20px; background: #f5f5f5; border-radius: 10px; }
        .suggestion-item { margin-bottom: 10px; font-size: 14px; color: #333; line-height: 1.6; }
        .download-area { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .download-btn { flex: 1; min-width: 120px; background: #00cc66; }
        .download-btn-json { background: #666; }
        .progress-bar { height: 6px; background: #eee; border-radius: 3px; margin-top: 10px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: #0088ff; width: 0; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>å‰ç«¯æ€§èƒ½è·‘åˆ†å·¥å…·ï¼ˆçº¯å‰ç«¯ç¨³å®šç‰ˆï¼‰</h1>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-area">
            <div class="input-item">
                <label for="test-type">æµ‹è¯•ç±»å‹</label>
                <select id="test-type">
                    <option value="current-page">é‡‡é›†å½“å‰é¡µé¢æ€§èƒ½ï¼ˆæ¨èï¼Œæ— ä»»ä½•é™åˆ¶ï¼‰</option>
                    <option value="custom-url">é‡‡é›†è‡ªå®šä¹‰HTTPS URLåŸºç¡€ä¿¡æ¯ï¼ˆä»…èƒ½è·å–å“åº”æ—¶é—´/çŠ¶æ€ç ï¼‰</option>
                </select>
                <div class="tips">æç¤ºï¼šé€‰æ‹©å¯¹åº”æµ‹è¯•ç±»å‹ï¼Œå½“å‰é¡µé¢æµ‹è¯•å¯è·å–å®Œæ•´æ€§èƒ½æ•°æ®</div>
            </div>
            <div class="input-item" id="url-container" style="display: none;">
                <label for="url">æµ‹è¯•URLï¼ˆå¿…é¡»ä¸ºHTTPSï¼‰</label>
                <input type="url" id="url" placeholder="å¦‚https://www.aliyun.com" required>
                <div class="tips warning">âš ï¸ è·¨åŸŸé™åˆ¶æç¤ºï¼šè‡ªå®šä¹‰URLä»…èƒ½è·å–â€œå“åº”æ—¶é—´ã€çŠ¶æ€ç ã€å†…å®¹å¤§å°â€ï¼Œæ— æ³•è·å–DNS/TCP/é¦–å±åŠ è½½ç­‰è¯¦ç»†æ€§èƒ½æ•°æ®ï¼ˆæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼‰ï¼Œå»ºè®®ä¼˜å…ˆæµ‹è¯•å½“å‰é¡µé¢</div>
            </div>
            <button id="testBtn">å¼€å§‹è·‘åˆ†æµ‹è¯•</button>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- ç»“æœåŒºåŸŸ -->
        <div class="result-area" id="resultArea">
            <!-- æ€§èƒ½è¯„åˆ† -->
            <div id="scoreDisplay"></div>
            <!-- æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ -->
            <div class="metrics" id="metrics">
                <!-- åŠ¨æ€æ’å…¥æŒ‡æ ‡ -->
            </div>
            <!-- èµ„æºåŠ è½½æ˜ç»†ï¼ˆä»…å½“å‰é¡µé¢æœ‰ï¼‰ -->
            <div class="resources-detail" id="resourcesDetail" style="display: none;">
                <h3>èµ„æºåŠ è½½æ˜ç»†</h3>
                <div id="resourcesList"></div>
            </div>
            <!-- å¯è§†åŒ–å›¾è¡¨ -->
            <div class="chart" id="chart"></div>
            <!-- ä¼˜åŒ–å»ºè®® -->
            <div class="suggestions" id="suggestions">
                <!-- åŠ¨æ€æ’å…¥å»ºè®® -->
            </div>
            <!-- ä¸‹è½½æŒ‰é’® -->
            <div class="download-area">
                <button class="download-btn" id="downloadPdfBtn">ä¸‹è½½PDFæŠ¥å‘Š</button>
                <button class="download-btn download-btn-json" id="downloadJsonBtn">ä¸‹è½½JSONåŸå§‹æ•°æ®</button>
            </div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒDOMå…ƒç´ 
        const testBtn = document.getElementById('testBtn');
        const resultArea = document.getElementById('resultArea');
        const testTypeSelect = document.getElementById('test-type');
        const urlContainer = document.getElementById('url-container');
        const urlInput = document.getElementById('url');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const resourcesDetail = document.getElementById('resourcesDetail');
        let performanceData = null; // å­˜å‚¨æ€§èƒ½æ•°æ®

        // æµ‹è¯•ç±»å‹åˆ‡æ¢æ˜¾ç¤º
        testTypeSelect.addEventListener('change', () => {
            if (testTypeSelect.value === 'custom-url') {
                urlContainer.style.display = 'block';
                resourcesDetail.style.display = 'none'; // è·¨åŸŸä¸æ˜¾ç¤ºèµ„æºæ˜ç»†
            } else {
                urlContainer.style.display = 'none';
                resourcesDetail.style.display = 'block'; // å½“å‰é¡µé¢æ˜¾ç¤ºèµ„æºæ˜ç»†
            }
        });

        // ç‚¹å‡»æµ‹è¯•æŒ‰é’®
        testBtn.addEventListener('click', async () => {
            const testType = testTypeSelect.value;
            let targetUrl = '';
            
            // åŸºç¡€æ ¡éªŒ
            if (testType === 'custom-url') {
                targetUrl = urlInput.value.trim();
                if (!targetUrl) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æµ‹è¯•URL');
                    return;
                }
                if (!targetUrl.startsWith('https://')) {
                    alert('æµ‹è¯•URLå¿…é¡»ä¸ºHTTPSåè®®');
                    return;
                }
            }

            // åˆå§‹åŒ–çŠ¶æ€
            testBtn.disabled = true;
            testBtn.innerText = 'æµ‹è¯•ä¸­...';
            progressBar.style.display = 'block';
            resultArea.style.display = 'none';
            updateProgress(0);

            try {
                // åˆ†æ­¥é‡‡é›†æ€§èƒ½æ•°æ®
                updateProgress(20);
                if (testType === 'current-page') {
                    // é‡‡é›†å½“å‰é¡µé¢å®Œæ•´æ€§èƒ½æ•°æ®
                    performanceData = await collectCurrentPagePerformance();
                } else {
                    // é‡‡é›†è‡ªå®šä¹‰URLåŸºç¡€æ•°æ®ï¼ˆé¿å…è·¨åŸŸæŠ¥é”™ï¼‰
                    performanceData = await collectCustomUrlBasicData(targetUrl);
                }

                updateProgress(80);
                // æ¸²æŸ“æ‰€æœ‰ç»“æœ
                renderAllResults(performanceData, testType);
                updateProgress(100);
                resultArea.style.display = 'block';

            } catch (error) {
                alert(`æµ‹è¯•å¤±è´¥ï¼š${error.message}`);
            } finally {
                // æ¢å¤çŠ¶æ€
                testBtn.disabled = false;
                testBtn.innerText = 'å¼€å§‹è·‘åˆ†æµ‹è¯•';
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    updateProgress(0);
                }, 500);
            }
        });

        // é‡‡é›†å½“å‰é¡µé¢çš„å®Œæ•´æ€§èƒ½æ•°æ®ï¼ˆæ— è·¨åŸŸé™åˆ¶ï¼‰
        async function collectCurrentPagePerformance() {
            // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
            if (document.readyState !== 'complete') {
                await new Promise(resolve => window.addEventListener('load', resolve));
            }

            // ç­‰å¾…Performance APIæ•°æ®å®Œæ•´
            await new Promise(resolve => setTimeout(resolve, 1000));

            const perf = window.performance;
            const navigation = perf.getEntriesByType('navigation')[0] || {};
            const resources = perf.getEntriesByType('resource') || [];

            // æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ï¼ˆçœŸå®å®Œæ•´æ•°æ®ï¼‰
            const data = {
                // å¯¼èˆªç›¸å…³æŒ‡æ ‡
                firstContentfulPaint: getFirstContentfulPaint(), // é¦–å±åŠ è½½æ—¶é—´
                tti: getTTI(), // äº¤äº’æ—¶é—´
                dnsTime: (navigation.domainLookupEnd || 0) - (navigation.domainLookupStart || 0), // DNSè§£ææ—¶é—´
                tcpTime: (navigation.connectEnd || 0) - (navigation.connectStart || 0), // TCPè¿æ¥æ—¶é—´
                requestTime: (navigation.responseStart || 0) - (navigation.requestStart || 0), // è¯·æ±‚å“åº”æ—¶é—´
                loadTime: (navigation.loadEventEnd || 0) - (navigation.loadEventStart || 0), // é¡µé¢åŠ è½½æ—¶é—´
                // èµ„æºç›¸å…³æŒ‡æ ‡
                totalResourceSize: resources.reduce((sum, item) => sum + (item.transferSize || 0), 0), // æ€»èµ„æºå¤§å°
                resourceCount: resources.length, // èµ„æºæ€»æ•°
                // èµ„æºæ˜ç»†
                resources: resources.map(item => ({
                    name: item.name,
                    type: item.initiatorType,
                    size: item.transferSize || 0,
                    loadTime: item.duration,
                    startTime: item.startTime
                })),
                // åŸºç¡€ä¿¡æ¯
                statusCode: 200,
                responseTime: (navigation.loadEventEnd || 0) - (navigation.fetchStart || 0),
                testTime: new Date().toLocaleString(),
                testUrl: window.location.href,
                isCrossDomain: false
            };

            return data;
        }

        // é‡‡é›†è‡ªå®šä¹‰URLçš„åŸºç¡€æ•°æ®ï¼ˆé¿å…è·¨åŸŸæŠ¥é”™ï¼Œä»…è·å–å‰ç«¯å¯è®¿é—®çš„ä¿¡æ¯ï¼‰
        async function collectCustomUrlBasicData(url) {
            try {
                const startTime = Date.now();
                // å‘èµ·ç®€å•GETè¯·æ±‚ï¼Œä»…è·å–åŸºç¡€å“åº”ä¿¡æ¯
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors', // æ˜ç¡®ä½¿ç”¨CORSæ¨¡å¼
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                    },
                    signal: AbortSignal.timeout(10000) // 10ç§’è¶…æ—¶
                });

                // è®¡ç®—åŸºç¡€å“åº”æ—¶é—´
                const responseTime = Date.now() - startTime;
                // è·å–å†…å®¹å¤§å°ï¼ˆä»…èƒ½è·å–å“åº”å¤´çš„content-lengthï¼‰
                const contentLength = response.headers.get('content-length');
                const totalResourceSize = contentLength ? parseInt(contentLength, 10) : 0;

                // æ„é€ åŸºç¡€æ•°æ®ï¼ˆè·¨åŸŸä»…èƒ½è·å–è¿™äº›ï¼Œå…¶ä»–æ ‡æ³¨ä¸ºå—é™ï¼‰
                return {
                    // è·¨åŸŸå—é™çš„æŒ‡æ ‡æ ‡æ³¨ä¸º0ï¼Œå¹¶è¯´æ˜
                    firstContentfulPaint: 0,
                    tti: 0,
                    dnsTime: 0,
                    tcpTime: 0,
                    requestTime: responseTime,
                    loadTime: 0,
                    // åŸºç¡€å¯è·å–çš„æŒ‡æ ‡
                    totalResourceSize: totalResourceSize,
                    resourceCount: 0,
                    resources: [],
                    statusCode: response.status,
                    responseTime: responseTime,
                    testTime: new Date().toLocaleString(),
                    testUrl: url,
                    isCrossDomain: true
                };
            } catch (error) {
                if (error.name === 'AbortError') {
                    throw new Error('è¯·æ±‚è¶…æ—¶ï¼ˆ10ç§’ï¼‰ï¼šç›®æ ‡URLæ— æ³•è®¿é—®æˆ–å“åº”è¿‡æ…¢');
                } else if (error.message.includes('CORS') || error.message.includes('è·¨åŸŸ')) {
                    throw new Error('è·¨åŸŸé™åˆ¶ï¼šç›®æ ‡ç½‘ç«™æœªé…ç½®CORSï¼Œæ— æ³•è·å–ä»»ä½•ä¿¡æ¯ï¼å»ºè®®ï¼š1. æ”¹ç”¨â€œå½“å‰é¡µé¢æµ‹è¯•â€ 2. è”ç³»ç›®æ ‡ç½‘ç«™é…ç½®Access-Control-Allow-Origin');
                } else if (error.message.includes('Failed to fetch')) {
                    throw new Error('è¯·æ±‚å¤±è´¥ï¼šç›®æ ‡URLæ— æ³•è®¿é—®ï¼ˆè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®ã€ç½‘ç»œæ˜¯å¦æ­£å¸¸ï¼‰');
                } else {
                    throw new Error(`è·å–åŸºç¡€æ•°æ®å¤±è´¥ï¼š${error.message}`);
                }
            }
        }

        // è·å–é¦–å±åŠ è½½æ—¶é—´ï¼ˆFCPï¼‰
        function getFirstContentfulPaint() {
            if (!('performance' in window) || !('getEntriesByType' in performance)) {
                return 0;
            }
            const fcpEntries = performance.getEntriesByType('paint').filter(entry => entry.name === 'first-contentful-paint');
            return fcpEntries.length > 0 ? Math.floor(fcpEntries[0].startTime) : 0;
        }

        // è·å–äº¤äº’æ—¶é—´ï¼ˆTTIï¼‰
        function getTTI() {
            const navigation = performance.getEntriesByType('navigation')[0] || {};
            return navigation ? Math.floor(navigation.domContentLoadedEventEnd || 0) : 0;
        }

        // è®¡ç®—æ€§èƒ½è¯„åˆ†ï¼ˆåŒºåˆ†è·¨åŸŸ/éè·¨åŸŸï¼‰
        function calculateScore(data, testType) {
            // è·¨åŸŸä»…åŸºäºå“åº”æ—¶é—´è¯„åˆ†
            if (testType === 'custom-url') {
                if (data.responseTime < 1000) return { score: 90, grade: 'A', desc: 'ä¼˜ç§€' };
                if (data.responseTime < 2000) return { score: 75, grade: 'B', desc: 'è‰¯å¥½' };
                if (data.responseTime < 3000) return { score: 60, grade: 'C', desc: 'åŠæ ¼' };
                return { score: 50, grade: 'D', desc: 'è¾ƒå·®' };
            }

            // éè·¨åŸŸå®Œæ•´è¯„åˆ†
            let score = 100;
            if (data.firstContentfulPaint > 1000) score -= Math.min(40, (data.firstContentfulPaint - 1000) / 100);
            if (data.totalResourceSize > 500 * 1024) score -= Math.min(30, (data.totalResourceSize - 500 * 1024) / (1024 * 10));
            if (data.tti > 2000) score -= Math.min(20, (data.tti - 2000) / 100);
            if (data.dnsTime + data.tcpTime > 500) score -= Math.min(10, (data.dnsTime + data.tcpTime - 500) / 50);
            score = Math.max(0, Math.floor(score));

            if (score >= 90) return { score, grade: 'A', desc: 'ä¼˜ç§€' };
            if (score >= 75) return { score, grade: 'B', desc: 'è‰¯å¥½' };
            if (score >= 60) return { score, grade: 'C', desc: 'åŠæ ¼' };
            return { score, grade: 'D', desc: 'è¾ƒå·®' };
        }

        // æ¸²æŸ“æ‰€æœ‰ç»“æœï¼ˆåŒºåˆ†è·¨åŸŸ/éè·¨åŸŸï¼‰
        function renderAllResults(data, testType) {
            // æ¸²æŸ“è¯„åˆ†
            const { score, grade, desc } = calculateScore(data, testType);
            document.getElementById('scoreDisplay').innerHTML = `
                <div class="score-box score-${grade}">
                    æ€§èƒ½è¯„åˆ†ï¼š${score}åˆ†ï¼ˆ${grade}çº§ - ${desc}ï¼‰
                    ${testType === 'custom-url' ? '<span style="font-size:12px; margin-left:8px;">ï¼ˆä»…åŸºäºå“åº”æ—¶é—´ï¼‰</span>' : ''}
                </div>
            `;

            // æ¸²æŸ“æ ¸å¿ƒæŒ‡æ ‡ï¼ˆåŒºåˆ†è·¨åŸŸæ ‡æ³¨ï¼‰
            renderMetrics(data, testType);

            // ä»…å½“å‰é¡µé¢æ¸²æŸ“èµ„æºæ˜ç»†
            if (testType === 'current-page') {
                renderResources(data.resources);
            }

            // æ¸²æŸ“å›¾è¡¨ï¼ˆé€‚é…è·¨åŸŸæ•°æ®ï¼‰
            renderChart(data, testType);

            // æ¸²æŸ“ä¼˜åŒ–å»ºè®®ï¼ˆåŒºåˆ†è·¨åŸŸï¼‰
            renderSuggestions(data, score, testType);
        }

        // æ¸²æŸ“æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ï¼ˆæ ‡æ³¨è·¨åŸŸå—é™æ•°æ®ï¼‰
        function renderMetrics(data, testType) {
            const metricsEl = document.getElementById('metrics');
            let metricsHtml = `
                <div class="metric-item"><strong>æµ‹è¯•URLï¼š</strong>${data.testUrl}</div>
                <div class="metric-item"><strong>æµ‹è¯•æ—¶é—´ï¼š</strong>${data.testTime}</div>
                <div class="metric-item"><strong>HTTPçŠ¶æ€ç ï¼š</strong>${data.statusCode}</div>
                <div class="metric-item"><strong>å“åº”æ—¶é—´ï¼š</strong>${(data.responseTime / 1000).toFixed(2)} ç§’</div>
            `;

            // éè·¨åŸŸå±•ç¤ºå®Œæ•´æŒ‡æ ‡
            if (testType === 'current-page') {
                metricsHtml += `
                    <div class="metric-item"><strong>é¦–å±åŠ è½½æ—¶é—´ï¼ˆFCPï¼‰ï¼š</strong>${(data.firstContentfulPaint / 1000).toFixed(2)} ç§’</div>
                    <div class="metric-item"><strong>äº¤äº’æ—¶é—´ï¼ˆTTIï¼‰ï¼š</strong>${(data.tti / 1000).toFixed(2)} ç§’</div>
                    <div class="metric-item"><strong>DNSè§£ææ—¶é—´ï¼š</strong>${(data.dnsTime / 1000).toFixed(2)} ç§’</div>
                    <div class="metric-item"><strong>TCPè¿æ¥æ—¶é—´ï¼š</strong>${(data.tcpTime / 1000).toFixed(2)} ç§’</div>
                    <div class="metric-item"><strong>è¯·æ±‚å“åº”æ—¶é—´ï¼š</strong>${(data.requestTime / 1000).toFixed(2)} ç§’</div>
                    <div class="metric-item"><strong>é¡µé¢åŠ è½½æ—¶é—´ï¼š</strong>${(data.loadTime / 1000).toFixed(2)} ç§’</div>
                    <div class="metric-item"><strong>æ€»èµ„æºå¤§å°ï¼š</strong>${(data.totalResourceSize / 1024).toFixed(2)} KB</div>
                    <div class="metric-item"><strong>èµ„æºæ€»æ•°ï¼š</strong>${data.resourceCount} ä¸ª</div>
                `;
            } else {
                // è·¨åŸŸæ ‡æ³¨å—é™æŒ‡æ ‡
                metricsHtml += `
                    <div class="metric-item"><strong>é¦–å±åŠ è½½æ—¶é—´ï¼ˆFCPï¼‰ï¼š</strong>0 ç§’ <span class="limited">ï¼ˆè·¨åŸŸå—é™ï¼Œæ— æ³•è·å–ï¼‰</span></div>
                    <div class="metric-item"><strong>äº¤äº’æ—¶é—´ï¼ˆTTIï¼‰ï¼š</strong>0 ç§’ <span class="limited">ï¼ˆè·¨åŸŸå—é™ï¼Œæ— æ³•è·å–ï¼‰</span></div>
                    <div class="metric-item"><strong>DNSè§£ææ—¶é—´ï¼š</strong>0 ç§’ <span class="limited">ï¼ˆè·¨åŸŸå—é™ï¼Œæ— æ³•è·å–ï¼‰</span></div>
                    <div class="metric-item"><strong>TCPè¿æ¥æ—¶é—´ï¼š</strong>0 ç§’ <span class="limited">ï¼ˆè·¨åŸŸå—é™ï¼Œæ— æ³•è·å–ï¼‰</span></div>
                    <div class="metric-item"><strong>æ€»èµ„æºå¤§å°ï¼š</strong>${(data.totalResourceSize / 1024).toFixed(2)} KB <span class="limited">ï¼ˆä»…å“åº”å¤´æ•°æ®ï¼Œéå®Œæ•´èµ„æºï¼‰</span></div>
                `;
            }

            metricsEl.innerHTML = metricsHtml;
        }

        // æ¸²æŸ“èµ„æºåŠ è½½æ˜ç»†ï¼ˆä»…å½“å‰é¡µé¢ï¼‰
        function renderResources(resources) {
            const resourcesList = document.getElementById('resourcesList');
            if (resources.length === 0) {
                resourcesList.innerHTML = '<div style="color: #666;">æš‚æ— èµ„æºæ•°æ®</div>';
                return;
            }

            // æŒ‰ç±»å‹åˆ†ç»„å±•ç¤º
            const grouped = { script: [], style: [], img: [], other: [] };
            resources.forEach(item => (grouped[item.type] ? grouped[item.type] : grouped.other).push(item));

            let html = '';
            if (grouped.script.length > 0) html += `<div style="margin-bottom:10px;"><strong>JSæ–‡ä»¶ï¼ˆ${grouped.script.length}ä¸ªï¼‰ï¼š</strong></div>` + grouped.script.map(item => 
                `<div class="resource-item">åç§°ï¼š${item.name.substring(0,50)}... | å¤§å°ï¼š${(item.size/1024).toFixed(2)}KB | åŠ è½½æ—¶é—´ï¼š${(item.loadTime/1000).toFixed(2)}s</div>`).join('');
            
            if (grouped.style.length > 0) html += `<div style="margin:10px 0;"><strong>CSSæ–‡ä»¶ï¼ˆ${grouped.style.length}ä¸ªï¼‰ï¼š</strong></div>` + grouped.style.map(item => 
                `<div class="resource-item">åç§°ï¼š${item.name.substring(0,50)}... | å¤§å°ï¼š${(item.size/1024).toFixed(2)}KB | åŠ è½½æ—¶é—´ï¼š${(item.loadTime/1000).toFixed(2)}s</div>`).join('');
            
            if (grouped.img.length > 0) html += `<div style="margin:10px 0;"><strong>å›¾ç‰‡æ–‡ä»¶ï¼ˆ${grouped.img.length}ä¸ªï¼‰ï¼š</strong></div>` + grouped.img.map(item => 
                `<div class="resource-item">åç§°ï¼š${item.name.substring(0,50)}... | å¤§å°ï¼š${(item.size/1024).toFixed(2)}KB | åŠ è½½æ—¶é—´ï¼š${(item.loadTime/1000).toFixed(2)}s</div>`).join('');
            
            if (grouped.other.length > 0) html += `<div style="margin-top:10px;"><strong>å…¶ä»–èµ„æºï¼ˆ${grouped.other.length}ä¸ªï¼‰ï¼š</strong></div>` + grouped.other.map(item => 
                `<div class="resource-item">åç§°ï¼š${item.name.substring(0,50)}... | ç±»å‹ï¼š${item.type} | å¤§å°ï¼š${(item.size/1024).toFixed(2)}KB | åŠ è½½æ—¶é—´ï¼š${(item.loadTime/1000).toFixed(2)}s</div>`).join('');

            resourcesList.innerHTML = html;
        }

        // æ¸²æŸ“å¯è§†åŒ–å›¾è¡¨ï¼ˆé€‚é…è·¨åŸŸæ•°æ®ï¼‰
        function renderChart(data, testType) {
            const chartDom = document.getElementById('chart');
            const myChart = echarts.init(chartDom);

            let xAxisData = ['å“åº”æ—¶é—´'];
            let seriesData = [(data.responseTime / 1000).toFixed(2)];
            
            // éè·¨åŸŸå±•ç¤ºå®Œæ•´æŒ‡æ ‡
            if (testType === 'current-page') {
                xAxisData = ['é¦–å±åŠ è½½', 'TTIäº¤äº’æ—¶é—´', 'DNSè§£æ', 'TCPè¿æ¥', 'è¯·æ±‚å“åº”', 'å“åº”æ—¶é—´'];
                seriesData = [
                    (data.firstContentfulPaint / 1000).toFixed(2),
                    (data.tti / 1000).toFixed(2),
                    (data.dnsTime / 1000).toFixed(2),
                    (data.tcpTime / 1000).toFixed(2),
                    (data.requestTime / 1000).toFixed(2),
                    (data.responseTime / 1000).toFixed(2)
                ];
            }

            const option = {
                title: { 
                    text: testType === 'current-page' ? 'æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡å¯¹æ¯”ï¼ˆå•ä½ï¼šç§’ï¼‰' : 'åŸºç¡€å“åº”æŒ‡æ ‡ï¼ˆå•ä½ï¼šç§’ï¼‰',
                    left: 'center' 
                },
                tooltip: { trigger: 'axis', formatter: '{b}ï¼š{c} ç§’' },
                legend: { data: ['æµ‹è¯•ç»“æœ'], bottom: 0 },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: { type: 'category', data: xAxisData },
                yAxis: { type: 'value', name: 'æ—¶é—´ï¼ˆç§’ï¼‰', axisLabel: { formatter: '{value} s' }, min: 0 },
                series: [{
                    name: 'æµ‹è¯•ç»“æœ',
                    type: 'bar',
                    barWidth: '40%',
                    itemStyle: { color: '#0088ff' },
                    data: seriesData
                }]
            };

            myChart.setOption(option);
            window.addEventListener('resize', () => myChart.resize());
        }

        // æ¸²æŸ“ä¼˜åŒ–å»ºè®®ï¼ˆåŒºåˆ†è·¨åŸŸï¼‰
        function renderSuggestions(data, score, testType) {
            const suggestionsEl = document.getElementById('suggestions');
            const suggestions = [];

            // è·¨åŸŸæµ‹è¯•ä»…ç»™å‡ºåŸºç¡€å»ºè®®
            if (testType === 'custom-url') {
                suggestions.push('âš ï¸ è·¨åŸŸæµ‹è¯•ä»…èƒ½è·å–åŸºç¡€å“åº”ä¿¡æ¯ï¼Œä»¥ä¸‹å»ºè®®åŸºäºå“åº”æ—¶é—´ç»™å‡ºï¼š');
                if (data.responseTime > 1000) {
                    suggestions.push('âœ… å“åº”æ—¶é—´åé•¿ï¼šå»ºè®®ç›®æ ‡ç½‘ç«™å¼€å¯CDNåŠ é€Ÿã€ä¼˜åŒ–æœåŠ¡å™¨å“åº”é€Ÿåº¦ã€å‡å°‘æ¥å£è€—æ—¶');
                } else {
                    suggestions.push('âœ… å“åº”æ—¶é—´ä¼˜ç§€ï¼šç›®æ ‡ç½‘ç«™åŸºç¡€è®¿é—®æ€§èƒ½è‰¯å¥½');
                }
                suggestions.push('ğŸ’¡ å¦‚éœ€è·å–å®Œæ•´æ€§èƒ½æ•°æ®ï¼Œè¯·æµ‹è¯•å½“å‰é¡µé¢ï¼ˆæ— è·¨åŸŸé™åˆ¶ï¼‰');
            } else {
                // éè·¨åŸŸç»™å‡ºå®Œæ•´å»ºè®®
                if (data.firstContentfulPaint > 1500) suggestions.push('âœ… é¦–å±åŠ è½½æ—¶é—´åé•¿ï¼šå¼€å¯é™æ€èµ„æºå‹ç¼©ã€å›¾ç‰‡æ‡’åŠ è½½ã€å‡å°‘é¦–å±éå¿…è¦JS/CSS');
                if (data.tti > 2500) suggestions.push('âœ… äº¤äº’æ—¶é—´ï¼ˆTTIï¼‰åé•¿ï¼šæ‹†åˆ†å¤§JSæ–‡ä»¶ã€å»¶è¿ŸåŠ è½½éé¦–å±è„šæœ¬ã€ä¼˜åŒ–DOMæ“ä½œ');
                if (data.dnsTime > 300) suggestions.push('âœ… DNSè§£ææ—¶é—´åé•¿ï¼šé…ç½®DNSé¢„è§£æã€ä½¿ç”¨çŸ­åŸŸåã€å¼€å¯DNSç¼“å­˜');
                if (data.tcpTime > 500) suggestions.push('âœ… TCPè¿æ¥æ—¶é—´åé•¿ï¼šå¼€å¯HTTP/2/HTTP/3ã€ä½¿ç”¨é•¿è¿æ¥');
                if (data.totalResourceSize > 1024 * 1024) suggestions.push(`âœ… æ€»èµ„æºè¿‡å¤§ï¼ˆ${(data.totalResourceSize/1024/1024).toFixed(2)}MBï¼‰ï¼šå‹ç¼©å›¾ç‰‡ã€JS/CSSï¼Œç§»é™¤æœªä½¿ç”¨ä»£ç `);
                if (data.resourceCount > 50) suggestions.push(`âœ… èµ„æºè¿‡å¤šï¼ˆ${data.resourceCount}ä¸ªï¼‰ï¼šåˆå¹¶JS/CSSã€ä½¿ç”¨é›ªç¢§å›¾`);

                // é«˜åˆ†æç¤º
                if (score >= 90) {
                    suggestions.unshift('ğŸ‰ é¡µé¢æ€§èƒ½ä¼˜ç§€ï¼æŒç»­ç›‘æ§å³å¯');
                } else if (score >= 75) {
                    suggestions.unshift('ğŸ‘ é¡µé¢æ€§èƒ½è‰¯å¥½ï¼Œé’ˆå¯¹æ€§ä¼˜åŒ–å³å¯');
                } else {
                    suggestions.unshift('âš ï¸ é¡µé¢æ€§èƒ½å¾…ä¼˜åŒ–ï¼Œä¼˜å…ˆè§£å†³ä»¥ä¸Šé—®é¢˜');
                }
            }

            suggestionsEl.innerHTML = suggestions.map(item => `<div class="suggestion-item">${item}</div>`).join('');
        }

        // ä¸‹è½½PDFæŠ¥å‘Š
        document.getElementById('downloadPdfBtn').addEventListener('click', async () => {
            if (!performanceData) {
                alert('æš‚æ— æµ‹è¯•æ•°æ®å¯ä¸‹è½½');
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const resultDom = document.getElementById('resultArea');
                const canvas = await html2canvas(resultDom, { scale: 2, useCORS: true, logging: false });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`å‰ç«¯æ€§èƒ½æµ‹è¯•æŠ¥å‘Š_${new Date().getTime()}.pdf`);
                alert('PDFæŠ¥å‘Šä¸‹è½½æˆåŠŸï¼');
            } catch (error) {
                alert(`PDFä¸‹è½½å¤±è´¥ï¼š${error.message}`);
            }
        });

        // ä¸‹è½½JSONåŸå§‹æ•°æ®
        document.getElementById('downloadJsonBtn').addEventListener('click', () => {
            if (!performanceData) {
                alert('æš‚æ— æµ‹è¯•æ•°æ®å¯ä¸‹è½½');
                return;
            }
            const blob = new Blob([JSON.stringify(performanceData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æ€§èƒ½æµ‹è¯•åŸå§‹æ•°æ®_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(percent) {
            progressFill.style.width = `${percent}%`;
        }
    </script>
</body>
</html>