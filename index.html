<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESA 前端性能跑分工具</title>
    <!-- 引入ECharts、jsPDF、html2canvas依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- 页面样式 -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .input-area { margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        .input-item { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select, button { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { background: #0088ff; color: white; border: none; cursor: pointer; margin-top: 10px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .result-area { display: none; margin-top: 30px; }
        .metrics { margin-bottom: 20px; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        .metric-item { margin-bottom: 10px; font-size: 14px; }
        .chart { width: 100%; height: 400px; margin: 20px 0; }
        .suggestions { margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; }
        .suggestion-item { margin-bottom: 8px; font-size: 14px; color: #333; }
        .download-btn { background: #00cc66; margin-top: 20px; }
        .tips { font-size: 12px; color: #999; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESA 前端性能跑分工具</h1>
        <!-- 输入区域 -->
        <div class="input-area">
            <div class="input-item">
                <label for="url">测试URL（如https://xxx.er.aliyun-esa.net）</label>
                <input type="url" id="url" placeholder="请输入需测试的前端项目URL（必须为HTTPS协议）" required>
                <div class="tips">提示：仅支持HTTPS协议的URL，避免浏览器拦截混合内容请求</div>
            </div>
            <div class="input-item">
                <label for="region">测试地区（ESA边缘节点）</label>
                <select id="region">
                    <option value="beijing">北京</option>
                    <option value="shanghai">上海</option>
                    <option value="guangzhou">广州</option>
                    <option value="shenzhen">深圳</option>
                    <option value="hangzhou">杭州</option>
                </select>
            </div>
            <button id="testBtn">开始跑分测试</button>
        </div>

        <!-- 结果区域 -->
        <div class="result-area" id="resultArea">
            <h2>测试报告</h2>
            <div class="metrics" id="metrics">
                <!-- 性能指标会动态插入 -->
            </div>
            <!-- 可视化图表 -->
            <div class="chart" id="chart"></div>
            <!-- 优化建议 -->
            <div class="suggestions" id="suggestions">
                <!-- 优化建议会动态插入 -->
            </div>
            <!-- PDF下载按钮 -->
            <button class="download-btn" id="downloadBtn">下载报告为PDF</button>
        </div>
    </div>

    <script>
        // 核心DOM元素
        const testBtn = document.getElementById('testBtn');
        const resultArea = document.getElementById('resultArea');
        const metricsEl = document.getElementById('metrics');
        const suggestionsEl = document.getElementById('suggestions');
        const downloadBtn = document.getElementById('downloadBtn');
        let testResult = null; // 存储测试结果

        // 点击测试按钮触发逻辑
        testBtn.addEventListener('click', async () => {
            const url = document.getElementById('url').value.trim();
            const region = document.getElementById('region').value;
            
            // 基础校验
            if (!url) {
                alert('请输入有效的测试URL');
                return;
            }
            if (!url.startsWith('https://')) {
                alert('测试URL必须为HTTPS协议，请修改后重试');
                return;
            }

            // 禁用按钮，显示加载状态
            testBtn.disabled = true;
            testBtn.innerText = '测试中...';
            resultArea.style.display = 'none'; // 隐藏旧结果

            try {
                // 拼接绝对API地址（避免相对路径解析错误）
                const apiUrl = `${window.location.origin}/performance-test`;
                // 配置15秒超时控制器
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                // 发起POST请求到ESA边缘函数
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, region }),
                    signal: controller.signal, // 绑定超时信号
                    credentials: 'include' // 允许携带凭证，适配跨域配置
                });

                // 清除超时定时器
                clearTimeout(timeoutId);

                // 检查HTTP响应状态
                if (!response.ok) {
                    throw new Error(`请求失败：HTTP ${response.status} ${response.statusText}`);
                }

                // 解析响应数据
                testResult = await response.json();
                
                // 业务逻辑错误处理
                if (testResult.code !== 200) {
                    throw new Error(testResult.msg || '测试失败：未返回有效结果');
                }

                // 渲染测试结果
                renderResult(testResult.data);
                resultArea.style.display = 'block';

            } catch (error) {
                // 细分错误类型，精准提示
                if (error.name === 'AbortError') {
                    alert('测试请求超时（15秒），请检查：1. ESA函数是否部署成功 2. 测试URL是否可正常访问');
                } else if (error.message.includes('mixed content')) {
                    alert('测试URL不能为HTTP协议，ESA页面为HTTPS，浏览器拦截混合内容请求');
                } else if (error.message.includes('Failed to fetch')) {
                    alert('请求失败：请检查1. ESA边缘函数是否部署成功 2. 跨域配置是否生效 3. 网络是否正常');
                } else {
                    alert(`测试失败：${error.message}`);
                }
            } finally {
                // 恢复按钮状态
                testBtn.disabled = false;
                testBtn.innerText = '开始跑分测试';
            }
        });

        // 渲染性能指标和图表
        function renderResult(data) {
            // 渲染核心性能指标
            metricsEl.innerHTML = `
                <div class="metric-item"><strong>测试地区：</strong>${getRegionName(data.region)}</div>
                <div class="metric-item"><strong>首屏加载时间：</strong>${(data.firstContentfulPaint / 1000).toFixed(2)} 秒</div>
                <div class="metric-item"><strong>资源总大小：</strong>${(data.resourceSize / 1024).toFixed(2)} KB</div>
                <div class="metric-item"><strong>交互时间（TTI）：</strong>${(data.tti / 1000).toFixed(2)} 秒</div>
                <div class="metric-item"><strong>DNS解析时间：</strong>${(data.dnsTime / 1000).toFixed(2)} 秒</div>
                <div class="metric-item"><strong>TCP连接时间：</strong>${(data.tcpTime / 1000).toFixed(2)} 秒</div>
                <div class="metric-item"><strong>测试时间：</strong>${data.testTime}</div>
            `;

            // 生成优化建议
            generateSuggestions(data);

            // 渲染可视化图表
            renderChart(data);
        }

        // 根据性能指标生成优化建议
        function generateSuggestions(data) {
            const suggestions = [];
            // 首屏加载时间阈值：>3秒需优化
            if (data.firstContentfulPaint > 3000) {
                suggestions.push('首屏加载时间过长（>3秒），建议开启ESA边缘压缩、图片懒加载、减少首屏非必要资源');
            }
            // 资源总大小阈值：>1MB需优化
            if (data.resourceSize > 1024 * 1024) {
                suggestions.push(`资源总大小过大（${(data.resourceSize / 1024 / 1024).toFixed(2)}MB），建议压缩JS/CSS文件、使用WebP/AVIF图片格式、开启Gzip压缩`);
            }
            // DNS解析时间阈值：>0.5秒需优化
            if (data.dnsTime > 500) {
                suggestions.push('DNS解析时间过长，建议配置DNS预解析（link rel="dns-prefetch"）、使用CDN加速、缩短域名长度');
            }
            // TCP连接时间阈值：>1秒需优化
            if (data.tcpTime > 1000) {
                suggestions.push('TCP连接时间过长，建议开启HTTP/2、使用长连接、优化服务器响应配置');
            }
            // TTI交互时间阈值：>5秒需优化
            if (data.tti > 5000) {
                suggestions.push('交互时间（TTI）过长，建议减少首屏JS执行时间、拆分大组件、使用懒加载加载非首屏脚本');
            }
            // 无优化点时的提示
            if (suggestions.length === 0) {
                suggestions.push('当前页面性能表现优秀，各项指标均在合理范围内，无需额外优化！');
            }

            // 渲染建议到页面
            suggestionsEl.innerHTML = suggestions.map(item => `<div class="suggestion-item">• ${item}</div>`).join('');
        }

        // 渲染ECharts可视化图表
        function renderChart(data) {
            const chartDom = document.getElementById('chart');
            // 初始化ECharts实例
            const myChart = echarts.init(chartDom);
            // 图表配置项
            const option = {
                title: { 
                    text: `性能指标对比 - ${getRegionName(data.region)}节点`,
                    left: 'center'
                },
                tooltip: { 
                    trigger: 'axis',
                    formatter: '{b}：{c} 秒'
                },
                legend: { 
                    data: [getRegionName(data.region) + '节点'],
                    bottom: 0
                },
                grid: { 
                    left: '3%', 
                    right: '4%', 
                    bottom: '10%', 
                    containLabel: true 
                },
                xAxis: {
                    type: 'category',
                    data: ['首屏加载', 'TTI交互时间', 'DNS解析', 'TCP连接']
                },
                yAxis: {
                    type: 'value',
                    name: '时间（秒）',
                    axisLabel: { formatter: '{value} s' },
                    min: 0 // Y轴从0开始，更直观
                },
                series: [
                    {
                        name: getRegionName(data.region) + '节点',
                        type: 'bar',
                        barWidth: '40%', // 柱子宽度
                        itemStyle: { color: '#0088ff' },
                        data: [
                            (data.firstContentfulPaint / 1000).toFixed(2),
                            (data.tti / 1000).toFixed(2),
                            (data.dnsTime / 1000).toFixed(2),
                            (data.tcpTime / 1000).toFixed(2)
                        ]
                    }
                ]
            };
            // 设置配置项并渲染
            myChart.setOption(option);
            // 监听窗口大小变化，自适应图表
            window.addEventListener('resize', () => myChart.resize());
        }

        // 下载PDF报告功能
        downloadBtn.addEventListener('click', async () => {
            if (!testResult) {
                alert('暂无测试报告可下载，请先完成跑分测试');
                return;
            }
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // 将结果区域转为canvas（解决HTML转PDF排版问题）
                const resultDom = document.getElementById('resultArea');
                const canvas = await html2canvas(resultDom, {
                    scale: 2, // 提高分辨率
                    useCORS: true, // 允许跨域图片
                    logging: false
                });
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4宽度（mm）
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                // 添加图片到PDF并保存
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`ESA性能测试报告_${getRegionName(testResult.data.region)}_${new Date().getTime()}.pdf`);
                alert('PDF报告下载成功！');
            } catch (error) {
                alert(`PDF下载失败：${error.message}`);
            }
        });

        // 辅助函数：地区值转中文名称
        function getRegionName(region) {
            const regionMap = {
                beijing: '北京',
                shanghai: '上海',
                guangzhou: '广州',
                shenzhen: '深圳',
                hangzhou: '杭州'
            };
            return regionMap[region] || region;
        }
    </script>
</body>
</html>