<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端性能跑分工具（专业报表版）</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft Yahei", Arial, sans-serif; }
        .container { max-width: 1600px; margin: 20px auto; padding: 0 20px; }
        h1 { color: #2f5496; margin-bottom: 25px; text-align: center; font-weight: 600; }
        .input-area { margin-bottom: 30px; padding: 30px; border: 1px solid #e6e6e6; border-radius: 16px; background: #fafafa; }
        .input-item { margin-bottom: 20px; }
        label { display: block; margin-bottom: 10px; font-weight: 600; color: #333; font-size: 16px; }
        input, select { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: #2f5496; box-shadow: 0 0 0 3px rgba(47, 84, 150, 0.1); }
        button { 
            width: 100%; padding: 14px; background: #2f5496; color: white; border: none; border-radius: 8px; 
            font-weight: 600; font-size: 16px; cursor: pointer; transition: background 0.3s;
        }
        button:hover { background: #1e3a66; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .tips { font-size: 13px; color: #666; margin-top: 8px; line-height: 1.6; }
        .tips.warning { color: #e64340; background: #fff0f0; padding: 10px; border-radius: 6px; margin-top: 10px; }
        .progress-area { margin-top: 15px; }
        .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: #2f5496; width: 0; transition: width 0.3s ease; }
        .progress-text { font-size: 12px; color: #666; margin-top: 5px; text-align: right; }

        /* 结果区域样式 */
        .result-area { display: none; margin-top: 30px; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .score-box { padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; font-size: 18px; }
        .score-A { background: #36b37e; }
        .score-B { background: #ffab00; }
        .score-C { background: #ff5630; }
        .score-D { background: #e64340; }
        .report-time { font-size: 14px; color: #666; }

        /* 报表模块 */
        .report-module { margin-bottom: 30px; padding: 25px; border: 1px solid #e6e6e6; border-radius: 12px; background: #fff; }
        .module-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #2f5496; display: flex; align-items: center; }
        .module-title i { margin-right: 8px; font-size: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .metric-card { padding: 15px; border: 1px solid #eee; border-radius: 8px; text-align: center; }
        .metric-card .value { font-size: 24px; font-weight: 600; color: #2f5496; margin: 10px 0; }
        .metric-card .label { font-size: 14px; color: #666; }
        .metric-card .benchmark { font-size: 12px; color: #999; margin-top: 5px; }

        /* 图表容器 */
        .chart-container { width: 100%; height: 400px; margin: 15px 0; }
        .mini-chart { height: 300px; }

        /* 资源明细 */
        .resource-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .resource-table th, .resource-table td { padding: 12px; border: 1px solid #eee; text-align: left; font-size: 14px; }
        .resource-table th { background: #fafafa; font-weight: 600; color: #333; }
        .resource-table tr:hover { background: #f9f9f9; }
        .resource-table .size { text-align: right; }
        .resource-table .type { color: #2f5496; font-weight: 500; }
        .big-file { color: #e64340; font-weight: 600; }

        /* 优化建议 */
        .suggestion-list { margin-top: 15px; }
        .suggestion-item { padding: 12px 15px; margin-bottom: 10px; border-left: 4px solid #2f5496; background: #f5f7fa; border-radius: 0 6px 6px 0; }
        .suggestion-item h4 { font-size: 15px; font-weight: 600; margin-bottom: 5px; }
        .suggestion-item p { font-size: 14px; color: #666; line-height: 1.5; }
        .suggestion-item a { color: #2f5496; text-decoration: none; }
        .suggestion-item a:hover { text-decoration: underline; }

        /* 下载区域 */
        .download-area { display: flex; gap: 15px; margin-top: 30px; }
        .download-btn { flex: 1; padding: 12px; font-size: 15px; }
        .download-pdf { background: #36b37e; }
        .download-pdf:hover { background: #25855a; }
        .download-json { background: #666; }
        .download-json:hover { background: #444; }

        /* 响应式适配 */
        @media (max-width: 1200px) {
            .grid-3 { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .download-area { flex-direction: column; }
        }
    </style>
    <!-- 引入图标库 -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>前端性能跑分工具（专业报表版）</h1>
        
        <!-- 输入区域 -->
        <div class="input-area">
            <div class="input-item">
                <label for="test-type">测试类型</label>
                <select id="test-type">
                    <option value="current-page">采集当前页面性能（推荐，完整指标）</option>
                    <option value="custom-url">采集自定义HTTPS URL基础信息（仅可达性）</option>
                </select>
                <div class="tips">提示：当前页面测试可获取 LCP/CLS/FID 等核心 Web 指标，自定义URL仅支持基础检测</div>
            </div>
            <div class="input-item" id="url-container" style="display: none;">
                <label for="url">测试URL（必须为HTTPS）</label>
                <input type="url" id="url" placeholder="如https://www.aliyun.com" required>
                <div class="tips warning">
                    <i class="fas fa-exclamation-triangle"></i> 跨域限制：自定义URL仅能获取响应时间、状态码，无法获取 LCP/CLS 等性能指标（浏览器安全策略）
                </div>
            </div>
            <button id="testBtn">开始跑分测试</button>
            <div class="progress-area">
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">准备测试...</div>
            </div>
        </div>

        <!-- 结果报表区域 -->
        <div class="result-area" id="resultArea">
            <div class="report-header">
                <div class="score-box" id="scoreBox">性能评分：95分（A级 - 优秀）</div>
                <div class="report-time" id="reportTime">测试时间：2024-01-01 12:00:00</div>
            </div>

            <!-- 核心性能指标模块 -->
            <div class="report-module">
                <div class="module-title"><i class="fas fa-chart-line"></i> 核心 Web 性能指标</div>
                <div class="grid-3">
                    <div class="metric-card" id="fcpCard">
                        <div class="label">首屏加载时间（FCP）</div>
                        <div class="value">1.2s</div>
                        <div class="benchmark">行业基准：≤1.8s（优秀）</div>
                    </div>
                    <div class="metric-card" id="lcpCard">
                        <div class="label">最大内容绘制（LCP）</div>
                        <div class="value">2.5s</div>
                        <div class="benchmark">行业基准：≤2.5s（良好）</div>
                    </div>
                    <div class="metric-card" id="clsCard">
                        <div class="label">累积布局偏移（CLS）</div>
                        <div class="value">0.02</div>
                        <div class="benchmark">行业基准：≤0.1（优秀）</div>
                    </div>
                    <div class="metric-card" id="ttiCard">
                        <div class="label">交互时间（TTI）</div>
                        <div class="value">3.0s</div>
                        <div class="benchmark">行业基准：≤3.8s（良好）</div>
                    </div>
                    <div class="metric-card" id="dnsCard">
                        <div class="label">DNS解析时间</div>
                        <div class="value">0.2s</div>
                        <div class="benchmark">行业基准：≤0.5s（优秀）</div>
                    </div>
                    <div class="metric-card" id="tcpCard">
                        <div class="label">TCP连接时间</div>
                        <div class="value">0.3s</div>
                        <div class="benchmark">行业基准：≤0.8s（优秀）</div>
                    </div>
                </div>
                <div class="chart-container" id="coreMetricsChart"></div>
            </div>

            <!-- 资源分析模块 -->
            <div class="report-module">
                <div class="module-title"><i class="fas fa-database"></i> 资源加载分析</div>
                <div class="grid-2">
                    <div>
                        <h4 style="margin-bottom: 15px; font-size: 15px;">资源类型占比</h4>
                        <div class="chart-container mini-chart" id="resourceTypeChart"></div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 15px; font-size: 15px;">资源加载时序</h4>
                        <div class="chart-container mini-chart" id="resourceTimingChart"></div>
                    </div>
                </div>
                <h4 style="margin: 20px 0 10px; font-size: 15px;">资源明细（前20条）</h4>
                <div style="overflow-x: auto;">
                    <table class="resource-table" id="resourceTable">
                        <thead>
                            <tr>
                                <th>资源名称</th>
                                <th>类型</th>
                                <th class="size">大小（KB）</th>
                                <th class="size">加载时间（s）</th>
                            </tr>
                        </thead>
                        <tbody id="resourceTableBody"></tbody>
                    </table>
                </div>
                <div id="resourceSummary" style="margin-top: 15px; font-size: 14px; color: #666;"></div>
            </div>

            <!-- 用户体验指标模块 -->
            <div class="report-module">
                <div class="module-title"><i class="fas fa-user-check"></i> 用户体验分析</div>
                <div class="grid-2">
                    <div class="metric-card">
                        <div class="label">首次输入延迟（FID）</div>
                        <div class="value" id="fidValue">0.08s</div>
                        <div class="benchmark">行业基准：≤0.1s（优秀）</div>
                    </div>
                    <div class="metric-card">
                        <div class="label">布局稳定性（CLS等级）</div>
                        <div class="value" id="clsGrade">A</div>
                        <div class="benchmark">说明：无明显布局偏移，用户体验佳</div>
                    </div>
                </div>
                <div class="chart-container" id="uxMetricsChart"></div>
                <div style="margin-top: 15px; padding: 15px; background: #f5f7fa; border-radius: 8px;">
                    <h4 style="font-size: 15px; margin-bottom: 10px;">性能等级说明</h4>
                    <ul style="font-size: 14px; color: #666; line-height: 1.8; padding-left: 20px;">
                        <li><strong>A级（90-100分）</strong>：性能卓越，用户体验极佳，无优化压力</li>
                        <li><strong>B级（75-89分）</strong>：性能良好，部分指标可优化，不影响核心体验</li>
                        <li><strong>C级（60-74分）</strong>：性能一般，存在明显瓶颈，需重点优化</li>
                        <li><strong>D级（0-59分）</strong>：性能较差，严重影响用户体验，需全面重构</li>
                    </ul>
                </div>
            </div>

            <!-- 优化建议模块 -->
            <div class="report-module">
                <div class="module-title"><i class="fas fa-lightbulb"></i> 针对性优化建议</div>
                <div class="suggestion-list" id="suggestionList"></div>
            </div>

            <!-- 下载区域 -->
            <div class="download-area">
                <button class="download-btn download-pdf" id="downloadPdfBtn">
                    <i class="fas fa-file-pdf"></i> 下载PDF完整报告
                </button>
                <button class="download-btn download-json" id="downloadJsonBtn">
                    <i class="fas fa-file-code"></i> 下载JSON原始数据
                </button>
            </div>
        </div>
    </div>

    <script>
        // 核心DOM元素
        const testBtn = document.getElementById('testBtn');
        const resultArea = document.getElementById('resultArea');
        const testTypeSelect = document.getElementById('test-type');
        const urlContainer = document.getElementById('url-container');
        const urlInput = document.getElementById('url');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        let performanceData = null;

        // 行业基准值（核心指标）
        const BENCHMARK = {
            fcp: { good: 1.8, normal: 3.0, poor: 3.0 },
            lcp: { good: 2.5, normal: 4.0, poor: 4.0 },
            cls: { good: 0.1, normal: 0.25, poor: 0.25 },
            tti: { good: 3.8, normal: 7.0, poor: 7.0 },
            dns: { good: 0.5, normal: 1.0, poor: 1.0 },
            tcp: { good: 0.8, normal: 1.5, poor: 1.5 },
            fid: { good: 0.1, normal: 0.3, poor: 0.3 }
        };

        // 测试类型切换
        testTypeSelect.addEventListener('change', () => {
            urlContainer.style.display = testTypeSelect.value === 'custom-url' ? 'block' : 'none';
        });

        // 点击测试按钮
        testBtn.addEventListener('click', async () => {
            const testType = testTypeSelect.value;
            let targetUrl = '';
            
            if (testType === 'custom-url') {
                targetUrl = urlInput.value.trim();
                if (!targetUrl) {
                    alert('请输入有效的测试URL');
                    return;
                }
                if (!targetUrl.startsWith('https://')) {
                    alert('测试URL必须为HTTPS协议');
                    return;
                }
            }

            // 初始化状态
            testBtn.disabled = true;
            testBtn.innerText = '测试中...';
            progressBar.style.display = 'block';
            resultArea.style.display = 'none';
            updateProgress(0, '准备采集数据...');

            try {
                updateProgress(20, '初始化性能采集...');
                if (testType === 'current-page') {
                    performanceData = await collectCurrentPagePerformance();
                } else {
                    performanceData = await collectCustomUrlBasicData(targetUrl);
                }

                updateProgress(70, '生成可视化报表...');
                renderFullReport(performanceData, testType);
                updateProgress(100, '报表生成完成！');
                resultArea.style.display = 'block';

            } catch (error) {
                alert(`测试失败：${error.message}`);
            } finally {
                testBtn.disabled = false;
                testBtn.innerText = '开始跑分测试';
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    updateProgress(0, '准备测试...');
                }, 1000);
            }
        });

        // 采集当前页面完整性能数据（核心函数）
        async function collectCurrentPagePerformance() {
            // 等待页面完全加载
            if (document.readyState !== 'complete') {
                await new Promise(resolve => window.addEventListener('load', resolve));
            }
            await new Promise(resolve => setTimeout(resolve, 1500));

            const perf = window.performance;
            const navigation = perf.getEntriesByType('navigation')[0] || {};
            const resources = perf.getEntriesByType('resource').slice(0, 20); // 取前20条资源

            // 修复点1：await获取LCP/FID（确保是数字类型）
            const fcp = getFirstContentfulPaint();
            const lcp = await getLargestContentfulPaint(); // 增加await
            const cls = getCumulativeLayoutShift();
            const fid = await getFirstInputDelay(); // 增加await
            const tti = (navigation.domContentLoadedEventEnd || 0) / 1000; // 转为秒，统一单位
            const dnsTime = ((navigation.domainLookupEnd || 0) - (navigation.domainLookupStart || 0)) / 1000; // 转为秒
            const tcpTime = ((navigation.connectEnd || 0) - (navigation.connectStart || 0)) / 1000; // 转为秒
            const responseTime = ((navigation.responseEnd || 0) - (navigation.requestStart || 0)) / 1000; // 转为秒

            // 修复点2：类型校验，确保所有指标都是数字
            const safeNumber = (val) => typeof val === 'number' && !isNaN(val) ? val : 0;
            
            // 资源分析
            const resourceStats = {
                totalCount: resources.length,
                totalSize: resources.reduce((sum, r) => sum + (r.transferSize || 0), 0),
                typeStats: {}
            };
            resources.forEach(r => {
                const type = r.initiatorType || 'other';
                resourceStats.typeStats[type] = (resourceStats.typeStats[type] || 0) + 1;
            });

            return {
                // 核心指标（增加类型安全处理）
                fcp: safeNumber(fcp),
                lcp: safeNumber(lcp),
                cls: safeNumber(cls),
                fid: safeNumber(fid),
                tti: safeNumber(tti),
                dnsTime: safeNumber(dnsTime),
                tcpTime: safeNumber(tcpTime),
                responseTime: safeNumber(responseTime),
                // 资源数据
                resources: resources.map(r => ({
                    name: r.name.substring(0, 60) + (r.name.length > 60 ? '...' : ''),
                    type: r.initiatorType || 'other',
                    size: r.transferSize || 0,
                    loadTime: r.duration || 0,
                    startTime: r.startTime || 0
                })),
                resourceStats,
                // 基础信息
                statusCode: 200,
                testUrl: window.location.href,
                testTime: new Date().toLocaleString(),
                isCrossDomain: false
            };
        }

        // 采集自定义URL基础数据
        async function collectCustomUrlBasicData(url) {
            const startTime = Date.now();
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'cors',
                    signal: AbortSignal.timeout(10000)
                });
                const responseTime = (Date.now() - startTime) / 1000; // 转为秒
                const contentLength = response.headers.get('content-length');
                const size = contentLength ? parseInt(contentLength, 10) : 0;

                // 所有指标默认0，确保类型安全
                return {
                    fcp: 0, lcp: 0, cls: 0, fid: 0, tti: 0, dnsTime: 0, tcpTime: 0,
                    responseTime: responseTime,
                    resources: [],
                    resourceStats: { totalCount: 0, totalSize: size, typeStats: {} },
                    statusCode: response.status,
                    testUrl: url,
                    testTime: new Date().toLocaleString(),
                    isCrossDomain: true
                };
            } catch (error) {
                if (error.name === 'AbortError') throw new Error('请求超时（10秒）：目标URL无法访问');
                if (error.message.includes('CORS')) throw new Error('跨域限制：目标网站未配置CORS，请改用当前页面测试');
                throw new Error(`请求失败：${error.message}`);
            }
        }

        // 核心指标采集辅助函数（修复类型问题）
        function getFirstContentfulPaint() {
            const entries = performance.getEntriesByType('paint');
            const fcpEntry = entries.find(e => e.name === 'first-contentful-paint');
            return fcpEntry ? fcpEntry.startTime / 1000 : 0; // 转为秒
        }

        // 修复点3：重构LCP采集函数，确保返回数字
        function getLargestContentfulPaint() {
            return new Promise(resolve => {
                let lcpValue = 0;
                // 兼容浏览器不支持的情况
                if (!('PerformanceObserver' in window)) {
                    resolve(0);
                    return;
                }
                const observer = new PerformanceObserver((entryList) => {
                    const entries = entryList.getEntries();
                    if (entries.length > 0) {
                        const lastEntry = entries[entries.length - 1];
                        lcpValue = lastEntry.startTime / 1000; // 转为秒
                    }
                    resolve(lcpValue);
                });
                try {
                    observer.observe({ type: 'largest-contentful-paint', buffered: true });
                } catch (e) {
                    resolve(0); // 浏览器不支持则返回0
                }
                // 兜底：1秒后返回，避免阻塞
                setTimeout(() => resolve(lcpValue), 1000);
            });
        }

        // 修复点4：重构CLS采集函数，确保返回数字
        function getCumulativeLayoutShift() {
            let clsValue = 0;
            if (!('PerformanceObserver' in window)) {
                return 0;
            }
            try {
                new PerformanceObserver((entryList) => {
                    for (const entry of entryList.getEntries()) {
                        if (!entry.hadRecentInput) {
                            clsValue += entry.value;
                        }
                    }
                }).observe({ type: 'layout-shift', buffered: true });
            } catch (e) {
                return 0;
            }
            return parseFloat(clsValue.toFixed(3)) || 0;
        }

        // 修复点5：重构FID采集函数，确保返回数字
        function getFirstInputDelay() {
            return new Promise(resolve => {
                let fidValue = 0;
                if (!('PerformanceObserver' in window)) {
                    resolve(0);
                    return;
                }
                const observer = new PerformanceObserver((entryList) => {
                    const entries = entryList.getEntries();
                    if (entries.length > 0) {
                        const firstEntry = entries[0];
                        fidValue = (firstEntry.processingStart - firstEntry.startTime) / 1000; // 转为秒
                    }
                    resolve(fidValue);
                });
                try {
                    observer.observe({ type: 'first-input', buffered: true });
                } catch (e) {
                    resolve(0);
                }
                setTimeout(() => resolve(fidValue), 1000);
            });
        }

        // 计算性能评分
        function calculateScore(data, testType) {
            if (testType === 'custom-url') {
                return data.responseTime < 1000 ? { score: 90, grade: 'A' } :
                       data.responseTime < 2000 ? { score: 75, grade: 'B' } :
                       data.responseTime < 3000 ? { score: 60, grade: 'C' } : { score: 50, grade: 'D' };
            }

            let score = 100;
            score -= data.fcp > BENCHMARK.fcp.good ? Math.min(20, (data.fcp - BENCHMARK.fcp.good) * 10) : 0;
            score -= data.lcp > BENCHMARK.lcp.good ? Math.min(20, (data.lcp - BENCHMARK.lcp.good) * 10) : 0;
            score -= data.cls > BENCHMARK.cls.good ? Math.min(20, (data.cls - BENCHMARK.cls.good) * 200) : 0;
            score -= data.dnsTime + data.tcpTime > 1.0 ? Math.min(20, (data.dnsTime + data.tcpTime - 1.0) * 20) : 0;
            score -= data.tti > BENCHMARK.tti.good ? Math.min(20, (data.tti - BENCHMARK.tti.good) * 5) : 0;
            score = Math.max(0, Math.floor(score));
            
            const grade = score >= 90 ? 'A' : score >= 75 ? 'B' : score >= 60 ? 'C' : 'D';
            return { score, grade };
        }

        // 渲染完整报表
        function renderFullReport(data, testType) {
            const { score, grade } = calculateScore(data, testType);
            const gradeDesc = { A: '优秀', B: '良好', C: '及格', D: '较差' };

            // 更新头部信息
            document.getElementById('scoreBox').innerHTML = `性能评分：${score}分（${grade}级 - ${gradeDesc[grade]}）`;
            document.getElementById('scoreBox').className = `score-box score-${grade}`;
            document.getElementById('reportTime').innerText = `测试时间：${data.testTime}`;

            // 渲染核心指标卡片
            renderMetricCard('fcpCard', data.fcp, BENCHMARK.fcp.good, 's');
            renderMetricCard('lcpCard', data.lcp, BENCHMARK.lcp.good, 's');
            renderMetricCard('clsCard', data.cls, BENCHMARK.cls.good, '', true);
            renderMetricCard('ttiCard', data.tti, BENCHMARK.tti.good, 's');
            renderMetricCard('dnsCard', data.dnsTime, BENCHMARK.dns.good, 's');
            renderMetricCard('tcpCard', data.tcpTime, BENCHMARK.tcp.good, 's');
            document.getElementById('fidValue').innerText = data.isCrossDomain ? '受限' : `${data.fid.toFixed(2)}s`;
            document.getElementById('clsGrade').innerText = data.cls <= 0.1 ? 'A' : data.cls <= 0.25 ? 'B' : 'C';

            // 渲染图表
            renderCoreMetricsChart(data, testType);
            renderResourceCharts(data, testType);
            renderUXMetricsChart(data, testType);

            // 渲染资源明细
            renderResourceTable(data.resources);
            document.getElementById('resourceSummary').innerText = `资源总数：${data.resourceStats.totalCount} | 总大小：${(data.resourceStats.totalSize / 1024).toFixed(2)}KB | 大文件（>200KB）数量：${data.resources.filter(r => r.size > 200 * 1024).length}`;

            // 渲染优化建议
            renderSuggestions(data, score, testType);

            // 绑定下载事件
            bindDownloadEvents(data);
        }

        // 修复点6：渲染指标卡片时增加类型校验
        function renderMetricCard(id, value, benchmark, unit = 's', isCls = false) {
            const card = document.getElementById(id);
            const valueEl = card.querySelector('.value');
            const benchmarkEl = card.querySelector('.benchmark');
            
            // 确保value是数字
            const numValue = typeof value === 'number' && !isNaN(value) ? value : 0;
            
            if (numValue === 0 && !isCls) {
                valueEl.innerText = '受限';
                benchmarkEl.innerText = '跨域/浏览器不支持';
                return;
            }

            const displayValue = isCls ? numValue.toFixed(3) : numValue.toFixed(2);
            valueEl.innerText = `${displayValue}${unit}`;
            
            const status = isCls ? numValue <= benchmark : numValue <= benchmark;
            benchmarkEl.innerText = status ? `行业基准：≤${benchmark}${unit}（优秀）` : `行业基准：≤${benchmark}${unit}（需优化）`;
            benchmarkEl.style.color = status ? '#36b37e' : '#ff5630';
        }

        // 渲染核心指标图表
        function renderCoreMetricsChart(data, testType) {
            const chart = echarts.init(document.getElementById('coreMetricsChart'));
            const option = {
                title: { text: '核心性能指标对比', left: 'center' },
                tooltip: { trigger: 'axis' },
                legend: { bottom: 0 },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: { type: 'category', data: testType === 'current-page' ? ['FCP', 'LCP', 'TTI', 'DNS', 'TCP'] : ['响应时间'] },
                yAxis: { type: 'value', name: '时间（s）' },
                series: [{
                    name: '当前值',
                    type: 'bar',
                    data: testType === 'current-page' ? 
                        [data.fcp.toFixed(2), data.lcp.toFixed(2), data.tti.toFixed(2), data.dnsTime.toFixed(2), data.tcpTime.toFixed(2)] : 
                        [(data.responseTime / 1000).toFixed(2)],
                    itemStyle: { color: '#2f5496' }
                }, {
                    name: '行业基准',
                    type: 'line',
                    data: testType === 'current-page' ? 
                        [BENCHMARK.fcp.good, BENCHMARK.lcp.good, BENCHMARK.tti.good, BENCHMARK.dns.good, BENCHMARK.tcp.good] : 
                        [1.8],
                    lineStyle: { color: '#ff5630', type: 'dashed' },
                    symbol: 'circle'
                }]
            };
            chart.setOption(option);
            window.addEventListener('resize', () => chart.resize());
        }

        // 渲染资源分析图表
        function renderResourceCharts(data, testType) {
            // 资源类型占比饼图
            const typeChart = echarts.init(document.getElementById('resourceTypeChart'));
            const typeData = Object.entries(data.resourceStats.typeStats).map(([type, count]) => ({ name: type, value: count }));
            typeChart.setOption({
                tooltip: { trigger: 'item' },
                series: [{
                    name: '资源类型',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: typeData,
                    label: { show: true, formatter: '{b}: {c}' }
                }]
            });

            // 资源加载时序图
            const timingChart = echarts.init(document.getElementById('resourceTimingChart'));
            if (testType === 'current-page' && data.resources.length > 0) {
                const timingData = data.resources.slice(0, 10).map(r => ({
                    name: r.name.substring(0, 10) + '...',
                    startTime: r.startTime / 1000,
                    duration: r.loadTime / 1000
                }));
                timingChart.setOption({
                    tooltip: { trigger: 'item' },
                    xAxis: { type: 'category', data: timingData.map(d => d.name) },
                    yAxis: { type: 'value', name: '时间（s）' },
                    series: [{
                        name: '加载耗时',
                        type: 'bar',
                        data: timingData.map(d => d.duration),
                        itemStyle: { color: '#36b37e' }
                    }]
                });
            } else {
                timingChart.setOption({
                    title: { text: '跨域限制，无数据', left: 'center' },
                    xAxis: { show: false },
                    yAxis: { show: false },
                    series: []
                });
            }

            window.addEventListener('resize', () => {
                typeChart.resize();
                timingChart.resize();
            });
        }

        // 渲染用户体验指标图表
        function renderUXMetricsChart(data, testType) {
            const chart = echarts.init(document.getElementById('uxMetricsChart'));
            if (testType === 'custom-url') {
                chart.setOption({ title: { text: '跨域限制，无用户体验数据', left: 'center' }, xAxis: { show: false }, yAxis: { show: false }, series: [] });
                return;
            }

            chart.setOption({
                title: { text: '用户体验指标评分', left: 'center' },
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: ['FCP', 'LCP', 'CLS', 'FID'] },
                yAxis: { type: 'value', max: 100, name: '评分' },
                series: [{
                    name: '体验评分',
                    type: 'bar',
                    data: [
                        Math.max(0, 100 - (data.fcp > BENCHMARK.fcp.good ? (data.fcp - BENCHMARK.fcp.good) * 20 : 0)),
                        Math.max(0, 100 - (data.lcp > BENCHMARK.lcp.good ? (data.lcp - BENCHMARK.lcp.good) * 20 : 0)),
                        Math.max(0, 100 - (data.cls > BENCHMARK.cls.good ? (data.cls - BENCHMARK.cls.good) * 200 : 0)),
                        Math.max(0, 100 - (data.fid > BENCHMARK.fid.good ? (data.fid - BENCHMARK.fid.good) * 100 : 0))
                    ],
                    itemStyle: { color: '#36b37e' }
                }]
            });
            window.addEventListener('resize', () => chart.resize());
        }

        // 渲染资源表格
        function renderResourceTable(resources) {
            const tbody = document.getElementById('resourceTableBody');
            tbody.innerHTML = '';
            
            if (resources.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #666;">无资源数据</td></tr>';
                return;
            }

            resources.forEach(r => {
                const sizeKB = (r.size / 1024).toFixed(2);
                const loadTime = (r.loadTime / 1000).toFixed(2);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.name}</td>
                    <td class="type">${r.type}</td>
                    <td class="size ${sizeKB > 200 ? 'big-file' : ''}">${sizeKB}</td>
                    <td class="size">${loadTime}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 渲染优化建议
        function renderSuggestions(data, score, testType) {
            const list = document.getElementById('suggestionList');
            list.innerHTML = '';

            if (testType === 'custom-url') {
                const suggestion = document.createElement('div');
                suggestion.className = 'suggestion-item';
                suggestion.innerHTML = `
                    <h4>基础访问优化建议</h4>
                    <p>${data.responseTime > 1000 ? '目标URL响应时间偏长，建议开启CDN加速、优化服务器带宽配置' : '目标URL响应速度优秀，无需额外优化'}</p>
                    <p>如需获取完整性能数据，请选择「采集当前页面性能」或联系目标网站配置CORS跨域头。</p>
                `;
                list.appendChild(suggestion);
                return;
            }

            const suggestions = [];
            if (data.fcp > BENCHMARK.fcp.good) suggestions.push({
                title: '首屏加载时间优化',
                content: '建议开启静态资源压缩、图片懒加载、减少首屏非必要JS/CSS加载，可使用ESA Pages边缘压缩功能提升速度。<a href="https://help.aliyun.com/document_detail/123456.html" target="_blank">查看ESA压缩配置文档</a>'
            });
            if (data.lcp > BENCHMARK.lcp.good) suggestions.push({
                title: '最大内容绘制（LCP）优化',
                content: '优化LCP元素（如首屏大图）的加载策略，使用WebP格式、设置合适的图片尺寸、开启预加载（link rel="preload"）。'
            });
            if (data.cls > BENCHMARK.cls.good) suggestions.push({
                title: '布局稳定性优化',
                content: '为图片、视频等元素设置固定宽高比，避免动态插入内容导致布局偏移，提升用户体验。'
            });
            if (data.dnsTime + data.tcpTime > 1.0) suggestions.push({
                title: '网络连接优化',
                content: '配置DNS预解析（link rel="dns-prefetch"）、使用HTTP/2协议、开启长连接，减少TCP握手次数。'
            });
            if (data.resources.filter(r => r.size > 200 * 1024).length > 0) suggestions.push({
                title: '大文件优化',
                content: '检测到多个大于200KB的资源文件，建议压缩JS/CSS、拆分大文件、使用按需加载策略。'
            });

            if (suggestions.length === 0) {
                suggestions.push({
                    title: '性能优秀，持续监控',
                    content: '当前页面各项性能指标均达行业优秀水平，建议定期进行性能回归测试，确保体验稳定。'
                });
            }

            suggestions.forEach(s => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `<h4>${s.title}</h4><p>${s.content}</p>`;
                list.appendChild(item);
            });
        }

        // 绑定下载事件
        function bindDownloadEvents(data) {
            // PDF下载
            document.getElementById('downloadPdfBtn').onclick = async () => {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('landscape', 'mm', 'a3'); // 横向A3，适配报表
                    const resultDom = document.getElementById('resultArea');
                    const canvas = await html2canvas(resultDom, { scale: 1.5, useCORS: true });
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = pdf.internal.pageSize.getWidth();
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    pdf.save(`前端性能测试报告_${new Date().getTime()}.pdf`);
                    alert('PDF报告下载成功！');
                } catch (error) {
                    alert(`PDF下载失败：${error.message}`);
                }
            };

            // JSON下载
            document.getElementById('downloadJsonBtn').onclick = () => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `性能测试原始数据_${new Date().getTime()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };
        }

        // 更新进度条
        function updateProgress(percent, text) {
            progressFill.style.width = `${percent}%`;
            progressText.innerText = text;
        }
    </script>
</body>
</html>